<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WatchParty - High Quality Audio</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PeerJS (WebRTC Wrapper) -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: white; overflow: hidden; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        /* Video Elements */
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
            border-radius: 0.5rem;
            transform: scaleX(-1); /* Mirror effect for self/webcam */
        }
        
        /* Screen share/File share shouldn't be mirrored */
        video.screen-share {
            transform: scaleX(1); 
            object-fit: contain; 
        }

        .video-container {
            position: relative;
            transition: all 0.3s ease;
        }

        .participant-label {
            position: absolute;
            bottom: 6px;
            left: 6px;
            background: rgba(0,0,0,0.6);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            pointer-events: none;
            white-space: nowrap;
        }

        .hidden { display: none !important; }
        
        /* Overlay for play button */
        .play-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            cursor: pointer;
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Navbar -->
    <header class="h-14 lg:h-16 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-4 lg:px-6 shrink-0 z-20">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-film text-blue-500 text-xl lg:text-2xl"></i>
            <h1 class="text-lg lg:text-xl font-bold tracking-tight">WatchParty</h1>
        </div>
        
        <div id="room-info" class="hidden flex items-center gap-3 bg-slate-800 px-3 py-1 lg:py-1.5 rounded-full border border-slate-700">
            <span class="hidden sm:inline text-xs text-slate-400 uppercase tracking-wider font-semibold">Room</span>
            <span id="display-room-id" class="font-mono text-blue-400 font-bold select-all cursor-pointer text-sm lg:text-base" title="Click to Copy">---</span>
            <button id="copy-btn" class="text-slate-400 hover:text-white transition-colors">
                <i class="fa-regular fa-copy"></i>
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <main class="flex-1 flex flex-col lg:flex-row overflow-hidden relative">
        
        <!-- Welcome / Setup Modal -->
        <div id="setup-screen" class="absolute inset-0 z-50 bg-slate-900/95 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-slate-800 border border-slate-700 p-6 lg:p-8 rounded-2xl shadow-2xl max-w-md w-full text-center">
                <div class="w-16 h-16 lg:w-20 lg:h-20 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto mb-4 lg:mb-6">
                    <i class="fa-solid fa-users-viewfinder text-3xl lg:text-4xl text-blue-500"></i>
                </div>
                <h2 class="text-xl lg:text-2xl font-bold mb-2">Watch Together</h2>
                <p class="text-slate-400 text-sm lg:text-base mb-6 lg:mb-8">Share movies or screens. <br>Use headphones for best audio.</p>

                <div class="space-y-3 lg:space-y-4">
                    <button id="create-room-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-3 px-4 rounded-xl transition-all flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus"></i> Create Room
                    </button>
                    
                    <div class="relative flex py-2 items-center">
                        <div class="flex-grow border-t border-slate-700"></div>
                        <span class="flex-shrink-0 mx-4 text-slate-500 text-xs">OR</span>
                        <div class="flex-grow border-t border-slate-700"></div>
                    </div>

                    <div class="flex gap-2">
                        <input type="text" id="room-input" placeholder="Room ID" class="flex-1 bg-slate-900 border border-slate-700 text-white px-4 py-3 rounded-xl focus:outline-none focus:border-blue-500 transition-colors uppercase font-mono text-center sm:text-left">
                        <button id="join-room-btn" class="bg-slate-700 hover:bg-slate-600 text-white font-semibold py-3 px-6 rounded-xl transition-all">
                            Join
                        </button>
                    </div>
                    <p id="status-msg" class="text-xs lg:text-sm h-5 text-red-400 font-medium"></p>
                </div>
            </div>
        </div>

        <!-- Cinema Area (Shared Screen) -->
        <div id="cinema-stage" class="flex-1 bg-black flex items-center justify-center relative p-2 lg:p-4 overflow-hidden">
            <div id="placeholder-cinema" class="text-center text-slate-600 px-4">
                <i class="fa-solid fa-display text-4xl lg:text-6xl mb-4 opacity-50"></i>
                <p class="text-base lg:text-lg font-medium">Waiting for content...</p>
                <p class="text-xs lg:text-sm opacity-60 mt-1 mb-4">Share screen or file to start.</p>
                <button onclick="window.location.reload()" class="text-xs bg-slate-800 hover:bg-slate-700 px-3 py-2 rounded text-slate-400 transition-colors">
                    <i class="fa-solid fa-rotate-right mr-1"></i> Refresh if stuck
                </button>
            </div>
            
            <div id="video-wrapper" class="relative w-full h-full hidden flex items-center justify-center">
                <!-- The Shared Screen Video Element -->
                <video id="shared-screen-video" autoplay playsinline class="screen-share shadow-2xl bg-black w-full h-full"></video>
                
                <!-- Manual Play Overlay -->
                <div id="play-overlay" class="play-overlay hidden">
                    <div class="text-center">
                        <i class="fa-solid fa-circle-play text-6xl text-white/80 hover:text-white transition-transform transform hover:scale-110 mb-2"></i>
                        <p class="text-sm font-semibold">Click to Join Stream</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Participants (Grid) -->
        <div id="participants-bar" class="
            h-32 lg:h-auto 
            w-full lg:w-72 
            bg-slate-900 
            border-t lg:border-t-0 lg:border-l border-slate-800 
            flex flex-col shrink-0 
            z-10">
            
            <div class="p-2 lg:p-4 border-b border-slate-800 flex justify-between items-center bg-slate-900 sticky left-0 top-0">
                <h3 class="font-semibold text-slate-300 text-sm">Friends</h3>
                <span id="participant-count" class="bg-slate-800 text-xs px-2 py-1 rounded text-slate-400">1 Online</span>
            </div>
            
            <!-- Video Container Grid -->
            <div id="video-grid" class="
                flex-1 p-2 lg:p-4 
                flex flex-row lg:flex-col 
                gap-2 
                overflow-x-auto lg:overflow-x-hidden lg:overflow-y-auto 
                items-center lg:items-stretch">
                
                <!-- My Video -->
                <div class="video-container aspect-video bg-slate-800 rounded-lg overflow-hidden border border-slate-700 relative group shrink-0 w-32 lg:w-full">
                    <video id="my-video" muted autoplay playsinline></video>
                    <div class="participant-label">You</div>
                    <!-- Mute indicator for self -->
                    <div id="my-mute-badge" class="absolute top-2 right-2 bg-red-500 rounded-full p-1 hidden">
                        <i class="fa-solid fa-microphone-slash text-[10px] text-white"></i>
                    </div>
                </div>
                <!-- Remote videos injected here -->
            </div>
        </div>
    </main>

    <!-- Bottom Controls -->
    <footer class="h-16 lg:h-20 bg-slate-900 border-t border-slate-800 flex items-center justify-between lg:justify-center gap-2 lg:gap-6 shrink-0 z-20 px-4">
        
        <!-- Left Side: AV Controls (Everyone) -->
        <div class="flex items-center gap-3">
            <button id="toggle-mic" class="w-10 h-10 lg:w-12 lg:h-12 rounded-full bg-slate-800 hover:bg-slate-700 text-white flex items-center justify-center transition-all border border-slate-700" title="Toggle Microphone">
                <i class="fa-solid fa-microphone text-sm lg:text-base"></i>
            </button>

            <button id="toggle-cam" class="w-10 h-10 lg:w-12 lg:h-12 rounded-full bg-slate-800 hover:bg-slate-700 text-white flex items-center justify-center transition-all border border-slate-700" title="Toggle Camera">
                <i class="fa-solid fa-video text-sm lg:text-base"></i>
            </button>

            <!-- Audio Mode Toggle -->
            <button id="toggle-audio-mode" class="w-10 h-10 lg:w-12 lg:h-12 rounded-full bg-slate-800 hover:bg-slate-700 text-yellow-400 flex items-center justify-center transition-all border border-slate-700" title="Toggle High Quality Audio (Headphones Recommended)">
                <i class="fa-solid fa-headset text-sm lg:text-base"></i>
            </button>
        </div>

        <div class="w-px h-6 lg:h-8 bg-slate-700 hidden lg:block"></div>

        <!-- Right Side: Sharing & Leave -->
        <div class="flex items-center gap-3">
            <button id="share-screen-btn" class="px-3 lg:px-5 h-10 lg:h-12 rounded-full bg-blue-600 hover:bg-blue-500 text-white font-semibold flex items-center gap-2 transition-all shadow-lg shadow-blue-500/20 text-sm lg:text-base">
                <i class="fa-solid fa-desktop"></i>
                <span class="hidden md:inline">Screen</span>
            </button>

            <!-- Hidden File Input -->
            <input type="file" id="file-input" accept="video/*" class="hidden">
            
            <button id="share-file-btn" class="px-3 lg:px-5 h-10 lg:h-12 rounded-full bg-purple-600 hover:bg-purple-500 text-white font-semibold flex items-center gap-2 transition-all shadow-lg shadow-purple-500/20 text-sm lg:text-base">
                <i class="fa-solid fa-file-video"></i>
                <span class="hidden md:inline">File</span>
            </button>

            <button id="leave-btn" class="w-10 h-10 lg:w-12 lg:h-12 rounded-full bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white flex items-center justify-center transition-all border border-red-500/20" title="Leave Room">
                <i class="fa-solid fa-phone-slash text-sm lg:text-base"></i>
            </button>
        </div>

    </footer>

    <!-- Logic -->
    <script>
        // --- State Management ---
        const state = {
            peer: null,
            myId: null,
            myStream: null,
            currentShareStream: null, 
            shareType: null,
            fileUrl: null,
            peers: {}, 
            isMuted: false,
            isVideoOff: false,
            isHQAudio: false // Default to standard voice (echo cancellation ON)
        };

        // --- DOM Elements ---
        const els = {
            setupScreen: document.getElementById('setup-screen'),
            createBtn: document.getElementById('create-room-btn'),
            joinBtn: document.getElementById('join-room-btn'),
            roomInput: document.getElementById('room-input'),
            roomInfo: document.getElementById('room-info'),
            displayRoomId: document.getElementById('display-room-id'),
            copyBtn: document.getElementById('copy-btn'),
            statusMsg: document.getElementById('status-msg'),
            
            myVideo: document.getElementById('my-video'),
            myMuteBadge: document.getElementById('my-mute-badge'),
            videoGrid: document.getElementById('video-grid'),
            
            cinemaStage: document.getElementById('cinema-stage'),
            placeholderCinema: document.getElementById('placeholder-cinema'),
            videoWrapper: document.getElementById('video-wrapper'),
            sharedScreenVideo: document.getElementById('shared-screen-video'),
            playOverlay: document.getElementById('play-overlay'),
            
            btnMic: document.getElementById('toggle-mic'),
            btnCam: document.getElementById('toggle-cam'),
            btnAudioMode: document.getElementById('toggle-audio-mode'),
            btnShareScreen: document.getElementById('share-screen-btn'),
            btnShareFile: document.getElementById('share-file-btn'),
            fileInput: document.getElementById('file-input'),
            btnLeave: document.getElementById('leave-btn'),
            partCount: document.getElementById('participant-count')
        };

        // --- Initialization ---

        async function initLocalStream(hqMode = false) {
            // Stop old tracks if any
            if (state.myStream) {
                state.myStream.getTracks().forEach(track => track.stop());
            }

            // HQ Mode = Disable noise suppression (Good for music, Bad for echo)
            // Voice Mode = Enable noise suppression (Good for chat, Bad for music)
            const audioConstraints = hqMode ? 
                { echoCancellation: false, noiseSuppression: false, autoGainControl: false } : 
                { echoCancellation: true, noiseSuppression: true, autoGainControl: true };

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: audioConstraints 
                });
                
                state.myStream = stream;
                els.myVideo.srcObject = stream;
                
                // Respect previous toggle states
                stream.getAudioTracks()[0].enabled = !state.isMuted;
                stream.getVideoTracks()[0].enabled = !state.isVideoOff;

                // Re-replace track in existing connections
                if (state.peer) {
                    replaceStreamInCalls(stream);
                }

                return true;
            } catch (err) {
                console.error("Failed to get local stream", err);
                showStatus("Error: Camera/Mic access denied.", true);
                return false;
            }
        }

        function replaceStreamInCalls(newStream) {
            Object.values(state.peers).forEach(peerObj => {
                if(peerObj.call && peerObj.call.peerConnection) {
                    const sender = peerObj.call.peerConnection.getSenders().find(s => s.track.kind === 'audio');
                    if (sender) sender.replaceTrack(newStream.getAudioTracks()[0]);
                    
                    const videoSender = peerObj.call.peerConnection.getSenders().find(s => s.track.kind === 'video');
                    if (videoSender) videoSender.replaceTrack(newStream.getVideoTracks()[0]);
                }
            });
        }

        function initPeer(customId = null) {
            return new Promise((resolve, reject) => {
                const peer = new Peer(customId, { debug: 1 });

                peer.on('open', (id) => {
                    state.myId = id;
                    state.peer = peer;
                    console.log('My Peer ID:', id);
                    resolve(id);
                });

                peer.on('error', (err) => {
                    console.error("PeerJS Error:", err);
                    showStatus("Connection Error: " + err.type, true);
                    reject(err);
                });

                peer.on('disconnected', () => {
                    showStatus("Reconnecting...", true);
                    peer.reconnect();
                });

                peer.on('call', (call) => {
                    handleIncomingCall(call);
                });
            });
        }

        // --- Call Handling ---

        function handleIncomingCall(call) {
            const isContentShare = call.metadata && call.metadata.type === 'content';
            
            // Answer with AV stream
            call.answer(state.myStream);

            call.on('stream', (remoteStream) => {
                if (isContentShare) {
                    setCinemaMode(remoteStream, false, false); 
                } else {
                    addRemoteVideo(call.peer, remoteStream);
                }
            });

            call.on('close', () => {
                if (isContentShare) {
                    stopCinemaMode();
                } else {
                    removeRemoteVideo(call.peer);
                }
            });

            if (!isContentShare) {
                state.peers[call.peer] = { call };
                updateParticipantCount();

                // Send active content to new joiner
                if (state.currentShareStream) {
                    setTimeout(() => {
                        state.peer.call(call.peer, state.currentShareStream, { 
                            metadata: { type: 'content' } 
                        });
                    }, 1000);
                }
            }
        }

        function connectToPeer(peerId) {
            if (!state.myStream) return;
            
            const call = state.peer.call(peerId, state.myStream, { metadata: { type: 'face' } });
            
            call.on('stream', (remoteStream) => {
                addRemoteVideo(peerId, remoteStream);
            });

            call.on('close', () => {
                removeRemoteVideo(peerId);
            });

            state.peers[peerId] = { call };
            updateParticipantCount();
        }

        // --- Content Sharing Logic ---

        function broadcastStream(stream) {
            Object.keys(state.peers).forEach(peerId => {
                state.peer.call(peerId, stream, { metadata: { type: 'content' } });
            });
        }

        function stopCurrentShare() {
            if (state.currentShareStream) {
                state.currentShareStream.getTracks().forEach(track => track.stop());
            }
            state.currentShareStream = null;
            state.shareType = null;
            
            if (state.fileUrl) {
                URL.revokeObjectURL(state.fileUrl);
                state.fileUrl = null;
            }

            stopCinemaMode();
            resetShareButtons();
        }

        async function startScreenShare() {
            if (state.currentShareStream) stopCurrentShare();

            try {
                // Request high quality audio for screen share
                const stream = await navigator.mediaDevices.getDisplayMedia({ 
                    video: { cursor: "always" }, 
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false,
                        channelCount: 2 // Stereo
                    }
                });
                state.currentShareStream = stream;
                state.shareType = 'screen';

                setCinemaMode(stream, true, false);
                updateShareButtons('screen');

                stream.getVideoTracks()[0].onended = () => stopCurrentShare();
                broadcastStream(stream);

            } catch (err) {
                console.error("Error sharing screen:", err);
                showStatus("Sharing cancelled.", true);
            }
        }

        els.btnShareFile.addEventListener('click', () => {
            if (state.shareType === 'file') {
                stopCurrentShare();
            } else {
                els.fileInput.click();
            }
        });

        els.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            startFileShare(file);
            e.target.value = ''; 
        });

        function startFileShare(file) {
            if (state.currentShareStream) stopCurrentShare();

            state.fileUrl = URL.createObjectURL(file);
            state.shareType = 'file';

            els.sharedScreenVideo.srcObject = null;
            els.sharedScreenVideo.src = state.fileUrl;
            
            els.sharedScreenVideo.oncanplay = () => {
                els.sharedScreenVideo.oncanplay = null;
                setCinemaMode(null, true, true); 
                
                // Capture stream - high quality
                const stream = els.sharedScreenVideo.captureStream ? 
                               els.sharedScreenVideo.captureStream() : 
                               els.sharedScreenVideo.mozCaptureStream();
                
                state.currentShareStream = stream;
                updateShareButtons('file');
                broadcastStream(stream);
                
                els.sharedScreenVideo.play();
            };
        }

        // --- UI Helpers ---

        function setCinemaMode(stream, isLocal, showControls) {
            els.placeholderCinema.classList.add('hidden');
            els.videoWrapper.classList.remove('hidden');
            els.sharedScreenVideo.classList.remove('hidden');
            els.playOverlay.classList.add('hidden');
            
            if (stream) {
                els.sharedScreenVideo.src = ""; 
                els.sharedScreenVideo.srcObject = stream;
            }

            els.sharedScreenVideo.controls = showControls;
            
            // Host settings
            if (isLocal) {
                els.sharedScreenVideo.muted = !showControls; 
            } else {
                // Remote settings
                els.sharedScreenVideo.muted = false; 
                const playPromise = els.sharedScreenVideo.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        els.playOverlay.classList.remove('hidden');
                    });
                }
            }
        }

        els.playOverlay.addEventListener('click', () => {
            els.sharedScreenVideo.play();
            els.playOverlay.classList.add('hidden');
        });

        function stopCinemaMode() {
            els.placeholderCinema.classList.remove('hidden');
            els.videoWrapper.classList.add('hidden');
            els.sharedScreenVideo.classList.add('hidden');
            els.sharedScreenVideo.srcObject = null;
            els.sharedScreenVideo.src = "";
            els.sharedScreenVideo.controls = false;
        }

        function resetShareButtons() {
            els.btnShareScreen.classList.remove('bg-red-600', 'hover:bg-red-700');
            els.btnShareScreen.classList.add('bg-blue-600', 'hover:bg-blue-500');
            els.btnShareScreen.innerHTML = `<i class="fa-solid fa-desktop"></i><span class="hidden md:inline">Screen</span>`;

            els.btnShareFile.classList.remove('bg-red-600', 'hover:bg-red-700');
            els.btnShareFile.classList.add('bg-purple-600', 'hover:bg-purple-500');
            els.btnShareFile.innerHTML = `<i class="fa-solid fa-file-video"></i><span class="hidden md:inline">File</span>`;
        }

        function updateShareButtons(type) {
            if (type === 'screen') {
                els.btnShareScreen.classList.add('bg-red-600', 'hover:bg-red-700');
                els.btnShareScreen.classList.remove('bg-blue-600', 'hover:bg-blue-500');
                els.btnShareScreen.innerHTML = `<i class="fa-solid fa-stop"></i><span class="hidden md:inline">Stop</span>`;
            } else if (type === 'file') {
                els.btnShareFile.classList.add('bg-red-600', 'hover:bg-red-700');
                els.btnShareFile.classList.remove('bg-purple-600', 'hover:bg-purple-500');
                els.btnShareFile.innerHTML = `<i class="fa-solid fa-stop"></i><span class="hidden md:inline">Stop</span>`;
            }
        }

        function addRemoteVideo(peerId, stream) {
            if (document.getElementById(`video-${peerId}`)) return;

            const div = document.createElement('div');
            div.id = `video-${peerId}`;
            div.className = "video-container aspect-video bg-slate-800 rounded-lg overflow-hidden border border-slate-700 relative animation-fade-in shrink-0 w-32 lg:w-full";
            div.innerHTML = `
                <video autoplay playsinline></video>
                <div class="participant-label">Friend</div>
            `;
            const video = div.querySelector('video');
            video.srcObject = stream;
            els.videoGrid.appendChild(div);
            updateParticipantCount();
        }

        function removeRemoteVideo(peerId) {
            const el = document.getElementById(`video-${peerId}`);
            if (el) el.remove();
            delete state.peers[peerId];
            updateParticipantCount();
        }

        function updateParticipantCount() {
            const count = Object.keys(state.peers).length + 1;
            els.partCount.innerText = `${count} Online`;
        }

        function showStatus(msg, isError = false) {
            els.statusMsg.innerText = msg;
            els.statusMsg.className = isError ? "text-xs lg:text-sm text-red-400 font-medium" : "text-xs lg:text-sm text-green-400 font-medium";
        }

        function generateRoomId() {
            return Math.random().toString(36).substring(2, 7).toUpperCase();
        }

        // --- Event Listeners ---

        els.createBtn.addEventListener('click', async () => {
            els.createBtn.disabled = true;
            els.createBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
            
            if (await initLocalStream()) {
                const roomId = generateRoomId();
                await initPeer(roomId);
                els.setupScreen.classList.add('hidden');
                els.roomInfo.classList.remove('hidden');
                els.displayRoomId.innerText = roomId;
            } else {
                els.createBtn.disabled = false;
                els.createBtn.innerHTML = `<i class="fa-solid fa-plus"></i> Create Room`;
            }
        });

        els.joinBtn.addEventListener('click', async () => {
            const roomId = els.roomInput.value.trim().toUpperCase();
            if (!roomId) return showStatus("Enter ID", true);

            els.joinBtn.disabled = true;
            els.joinBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;

            if (await initLocalStream()) {
                await initPeer(); 
                connectToPeer(roomId);
                els.setupScreen.classList.add('hidden');
                els.roomInfo.classList.remove('hidden');
                els.displayRoomId.innerText = roomId;
            } else {
                els.joinBtn.disabled = false;
                els.joinBtn.innerText = "Join";
            }
        });

        els.copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(els.displayRoomId.innerText);
            const originalIcon = els.copyBtn.innerHTML;
            els.copyBtn.innerHTML = `<i class="fa-solid fa-check text-green-500"></i>`;
            setTimeout(() => { els.copyBtn.innerHTML = originalIcon; }, 2000);
        });

        // Toggle Mic
        els.btnMic.addEventListener('click', () => {
            state.isMuted = !state.isMuted;
            if (state.myStream) {
                state.myStream.getAudioTracks()[0].enabled = !state.isMuted;
            }
            
            els.btnMic.innerHTML = state.isMuted 
                ? `<i class="fa-solid fa-microphone-slash text-sm lg:text-base"></i>` 
                : `<i class="fa-solid fa-microphone text-sm lg:text-base"></i>`;
            els.btnMic.classList.toggle('bg-red-500', state.isMuted);
            els.btnMic.classList.toggle('bg-slate-800', !state.isMuted);
            
            if (state.isMuted) els.myMuteBadge.classList.remove('hidden');
            else els.myMuteBadge.classList.add('hidden');
        });

        // Toggle Cam
        els.btnCam.addEventListener('click', () => {
            state.isVideoOff = !state.isVideoOff;
            if (state.myStream) {
                state.myStream.getVideoTracks()[0].enabled = !state.isVideoOff;
            }
            
            els.btnCam.innerHTML = state.isVideoOff 
                ? `<i class="fa-solid fa-video-slash text-sm lg:text-base"></i>` 
                : `<i class="fa-solid fa-video text-sm lg:text-base"></i>`;
            els.btnCam.classList.toggle('bg-red-500', state.isVideoOff);
            els.btnCam.classList.toggle('bg-slate-800', !state.isVideoOff);
        });

        // Toggle Audio Mode (Voice vs Cinema)
        els.btnAudioMode.addEventListener('click', async () => {
            state.isHQAudio = !state.isHQAudio;
            
            // Re-init stream with new constraints
            await initLocalStream(state.isHQAudio);
            
            // Visual feedback
            if (state.isHQAudio) {
                // HQ Mode ON (Cinema)
                els.btnAudioMode.innerHTML = `<i class="fa-solid fa-music text-sm lg:text-base"></i>`;
                els.btnAudioMode.classList.remove('text-yellow-400');
                els.btnAudioMode.classList.add('bg-green-600', 'text-white');
                els.btnAudioMode.title = "Cinema Mode (Use Headphones)";
                showStatus("Cinema Audio Mode ON. Use Headphones!", false);
            } else {
                // Voice Mode ON
                els.btnAudioMode.innerHTML = `<i class="fa-solid fa-headset text-sm lg:text-base"></i>`;
                els.btnAudioMode.classList.add('text-yellow-400');
                els.btnAudioMode.classList.remove('bg-green-600', 'text-white');
                els.btnAudioMode.title = "Voice Mode (Echo Cancelled)";
                showStatus("Voice Chat Mode ON", false);
            }
            
            // Clear status after 3s
            setTimeout(() => showStatus(""), 3000);
        });

        els.btnShareScreen.addEventListener('click', () => {
            if (state.shareType === 'screen') {
                stopCurrentShare();
            } else {
                startScreenShare();
            }
        });

        els.btnLeave.addEventListener('click', () => {
            if (confirm("Leave room?")) window.location.reload();
        });

    </script>
</body>
</html>
