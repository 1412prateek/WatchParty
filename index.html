<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WatchParty - Realtime Screen Sharing & Chat</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PeerJS (WebRTC Wrapper) -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: white; overflow: hidden; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        /* Video Elements */
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
            border-radius: 0.5rem;
            transform: scaleX(-1); /* Mirror effect for self/webcam */
        }
        
        /* Screen share shouldn't be mirrored */
        video.screen-share {
            transform: scaleX(1); 
            object-fit: contain; 
        }

        .video-container {
            position: relative;
            transition: all 0.3s ease;
        }

        .participant-label {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background: rgba(0,0,0,0.6);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            pointer-events: none;
        }

        /* Animations */
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .animate-pulse-ring { animation: pulse-ring 2s infinite; }

        .hidden { display: none !important; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Navbar -->
    <header class="h-16 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-6 shrink-0 z-20">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-film text-blue-500 text-2xl"></i>
            <h1 class="text-xl font-bold tracking-tight">WatchParty</h1>
        </div>
        
        <div id="room-info" class="hidden flex items-center gap-4 bg-slate-800 px-4 py-1.5 rounded-full border border-slate-700">
            <span class="text-xs text-slate-400 uppercase tracking-wider font-semibold">Room ID</span>
            <span id="display-room-id" class="font-mono text-blue-400 font-bold select-all cursor-pointer" title="Click to Copy">---</span>
            <button id="copy-btn" class="text-slate-400 hover:text-white transition-colors">
                <i class="fa-regular fa-copy"></i>
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <main class="flex-1 flex overflow-hidden relative">
        
        <!-- Welcome / Setup Modal -->
        <div id="setup-screen" class="absolute inset-0 z-50 bg-slate-900/95 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-slate-800 border border-slate-700 p-8 rounded-2xl shadow-2xl max-w-md w-full text-center">
                <div class="w-20 h-20 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fa-solid fa-users-viewfinder text-4xl text-blue-500"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">Start Watching Together</h2>
                <p class="text-slate-400 mb-8">Share your screen or join a friend's room to watch movies, videos, and photos in real-time.</p>

                <div class="space-y-4">
                    <button id="create-room-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-3 px-4 rounded-xl transition-all flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus"></i> Create New Room
                    </button>
                    
                    <div class="relative flex py-2 items-center">
                        <div class="flex-grow border-t border-slate-700"></div>
                        <span class="flex-shrink-0 mx-4 text-slate-500 text-sm">OR</span>
                        <div class="flex-grow border-t border-slate-700"></div>
                    </div>

                    <div class="flex gap-2">
                        <input type="text" id="room-input" placeholder="Enter Room ID" class="flex-1 bg-slate-900 border border-slate-700 text-white px-4 py-3 rounded-xl focus:outline-none focus:border-blue-500 transition-colors uppercase font-mono">
                        <button id="join-room-btn" class="bg-slate-700 hover:bg-slate-600 text-white font-semibold py-3 px-6 rounded-xl transition-all">
                            Join
                        </button>
                    </div>
                    <p id="status-msg" class="text-sm h-5 text-red-400 font-medium"></p>
                </div>
            </div>
        </div>

        <!-- Cinema Area (Shared Screen) -->
        <div id="cinema-stage" class="flex-1 bg-black flex items-center justify-center relative p-4">
            <div id="placeholder-cinema" class="text-center text-slate-600">
                <i class="fa-solid fa-display text-6xl mb-4 opacity-50"></i>
                <p class="text-lg font-medium">Waiting for screen share...</p>
                <p class="text-sm opacity-60">Click the "Share Screen" button to start casting.</p>
            </div>
            <!-- The Shared Screen Video Element -->
            <video id="shared-screen-video" autoplay playsinline class="screen-share hidden shadow-2xl"></video>
        </div>

        <!-- Sidebar Participants (Grid) -->
        <div id="participants-bar" class="w-80 bg-slate-900 border-l border-slate-800 flex flex-col shrink-0 transition-all duration-300 transform translate-x-0">
            <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                <h3 class="font-semibold text-slate-300">Friends</h3>
                <span id="participant-count" class="bg-slate-800 text-xs px-2 py-1 rounded text-slate-400">1 Online</span>
            </div>
            
            <div id="video-grid" class="flex-1 overflow-y-auto p-4 space-y-4">
                <!-- My Video -->
                <div class="video-container aspect-video bg-slate-800 rounded-lg overflow-hidden border border-slate-700 relative group">
                    <video id="my-video" muted autoplay playsinline></video>
                    <div class="participant-label">You</div>
                    <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                        <i class="fa-solid fa-microphone-lines text-white"></i>
                    </div>
                </div>
                <!-- Remote videos injected here -->
            </div>
        </div>
    </main>

    <!-- Bottom Controls -->
    <footer class="h-20 bg-slate-900 border-t border-slate-800 flex items-center justify-center gap-4 shrink-0 z-20">
        
        <button id="toggle-mic" class="w-12 h-12 rounded-full bg-slate-800 hover:bg-slate-700 text-white flex items-center justify-center transition-all border border-slate-700" title="Toggle Microphone">
            <i class="fa-solid fa-microphone"></i>
        </button>

        <button id="toggle-cam" class="w-12 h-12 rounded-full bg-slate-800 hover:bg-slate-700 text-white flex items-center justify-center transition-all border border-slate-700" title="Toggle Camera">
            <i class="fa-solid fa-video"></i>
        </button>

        <div class="w-px h-8 bg-slate-700 mx-2"></div>

        <button id="share-screen-btn" class="px-6 h-12 rounded-full bg-blue-600 hover:bg-blue-500 text-white font-semibold flex items-center gap-2 transition-all shadow-lg shadow-blue-500/20">
            <i class="fa-solid fa-desktop"></i>
            <span>Share Screen</span>
        </button>

        <div class="w-px h-8 bg-slate-700 mx-2"></div>

        <button id="leave-btn" class="w-12 h-12 rounded-full bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white flex items-center justify-center transition-all border border-red-500/20" title="Leave Room">
            <i class="fa-solid fa-phone-slash"></i>
        </button>

    </footer>

    <!-- Logic -->
    <script>
        // --- State Management ---
        const state = {
            peer: null,
            myId: null,
            myStream: null,
            screenStream: null,
            peers: {}, // Map<peerId, {call, videoEl}>
            isMuted: false,
            isVideoOff: false,
            isSharing: false
        };

        // --- DOM Elements ---
        const els = {
            setupScreen: document.getElementById('setup-screen'),
            createBtn: document.getElementById('create-room-btn'),
            joinBtn: document.getElementById('join-room-btn'),
            roomInput: document.getElementById('room-input'),
            roomInfo: document.getElementById('room-info'),
            displayRoomId: document.getElementById('display-room-id'),
            copyBtn: document.getElementById('copy-btn'),
            statusMsg: document.getElementById('status-msg'),
            
            myVideo: document.getElementById('my-video'),
            videoGrid: document.getElementById('video-grid'),
            
            cinemaStage: document.getElementById('cinema-stage'),
            placeholderCinema: document.getElementById('placeholder-cinema'),
            sharedScreenVideo: document.getElementById('shared-screen-video'),
            
            btnMic: document.getElementById('toggle-mic'),
            btnCam: document.getElementById('toggle-cam'),
            btnShare: document.getElementById('share-screen-btn'),
            btnLeave: document.getElementById('leave-btn'),
            partCount: document.getElementById('participant-count')
        };

        // --- Initialization ---

        // 1. Get Local User Media (Camera/Mic)
        async function initLocalStream() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                state.myStream = stream;
                els.myVideo.srcObject = stream;
                return true;
            } catch (err) {
                console.error("Failed to get local stream", err);
                showStatus("Error: Camera/Mic access denied. Please allow permissions.", true);
                return false;
            }
        }

        // 2. Initialize PeerJS
        function initPeer(customId = null) {
            return new Promise((resolve, reject) => {
                // Using standard free peerjs server
                const peer = new Peer(customId, {
                    debug: 2
                });

                peer.on('open', (id) => {
                    state.myId = id;
                    state.peer = peer;
                    console.log('My Peer ID:', id);
                    resolve(id);
                });

                peer.on('error', (err) => {
                    console.error("PeerJS Error:", err);
                    if(err.type === 'unavailable-id') {
                        showStatus("Room ID already taken or invalid.");
                    } else if (err.type === 'peer-unavailable') {
                        showStatus("Room not found. Check the ID.");
                    } else {
                        showStatus("Connection error. Try refreshing.");
                    }
                    reject(err);
                });

                // Answer Incoming Calls
                peer.on('call', (call) => {
                    handleIncomingCall(call);
                });
            });
        }

        // --- Call Handling ---

        function handleIncomingCall(call) {
            // Check metadata to see if it's a screen share or a user face
            const isScreenShare = call.metadata && call.metadata.type === 'screen';
            
            console.log("Incoming call. Is Screen Share?", isScreenShare);

            // Answer the call. 
            // If it's a screen share coming in, we answer with null (we don't send video back to the screen share stream usually)
            // or we answer with our audio only. For simplicity, we answer with our main stream.
            call.answer(state.myStream);

            call.on('stream', (remoteStream) => {
                if (isScreenShare) {
                    setCinemaMode(remoteStream);
                } else {
                    addRemoteVideo(call.peer, remoteStream);
                }
            });

            call.on('close', () => {
                if (isScreenShare) {
                    stopCinemaMode();
                } else {
                    removeRemoteVideo(call.peer);
                }
            });

            // Store call reference if it's a participant
            if (!isScreenShare) {
                state.peers[call.peer] = { call };
                updateParticipantCount();
            }
        }

        function connectToPeer(peerId) {
            if (!state.myStream) return;
            
            // 1. Call for Video Chat
            const call = state.peer.call(peerId, state.myStream, { metadata: { type: 'face' } });
            
            call.on('stream', (remoteStream) => {
                // When we call them, they answer with their stream
                addRemoteVideo(peerId, remoteStream);
            });

            call.on('close', () => {
                removeRemoteVideo(peerId);
            });

            state.peers[peerId] = { call };
            updateParticipantCount();
        }

        // --- Screen Sharing Logic ---

        async function startScreenShare() {
            try {
                // Get screen stream
                const stream = await navigator.mediaDevices.getDisplayMedia({ 
                    video: { cursor: "always" }, 
                    audio: true 
                });
                state.screenStream = stream;

                // Show locally
                setCinemaMode(stream, true);
                
                // Update Button UI
                els.btnShare.classList.add('bg-red-600', 'hover:bg-red-700');
                els.btnShare.classList.remove('bg-blue-600', 'hover:bg-blue-500');
                els.btnShare.innerHTML = `<i class="fa-solid fa-stop"></i><span>Stop Share</span>`;
                state.isSharing = true;

                // Detect when user clicks "Stop Sharing" in browser native UI
                stream.getVideoTracks()[0].onended = () => {
                    stopScreenShare();
                };

                // CALL EVERYONE with the screen stream
                Object.keys(state.peers).forEach(peerId => {
                    const call = state.peer.call(peerId, stream, { metadata: { type: 'screen' } });
                    // We don't really need to handle the answer stream for screen shares
                });

            } catch (err) {
                console.error("Error sharing screen:", err);
            }
        }

        function stopScreenShare() {
            if (!state.screenStream) return;

            // Stop tracks
            state.screenStream.getTracks().forEach(track => track.stop());
            state.screenStream = null;

            // Reset UI
            stopCinemaMode();
            els.btnShare.classList.remove('bg-red-600', 'hover:bg-red-700');
            els.btnShare.classList.add('bg-blue-600', 'hover:bg-blue-500');
            els.btnShare.innerHTML = `<i class="fa-solid fa-desktop"></i><span>Share Screen</span>`;
            state.isSharing = false;
            
            // Note: PeerJS calls close automatically when track ends usually, but we might need to notify peers manually in a robust app.
            // For this simple version, simply stopping tracks usually kills the freeze frame on the other end or we'd need a data channel signal.
            // The receiver sees stream end or 'mute'. 
        }

        // --- UI Helpers ---

        function setCinemaMode(stream, isLocal = false) {
            els.placeholderCinema.classList.add('hidden');
            els.sharedScreenVideo.classList.remove('hidden');
            els.sharedScreenVideo.srcObject = stream;
            
            // If it's local screen share, mute it so we don't hear ourselves
            els.sharedScreenVideo.muted = isLocal;
        }

        function stopCinemaMode() {
            els.placeholderCinema.classList.remove('hidden');
            els.sharedScreenVideo.classList.add('hidden');
            els.sharedScreenVideo.srcObject = null;
        }

        function addRemoteVideo(peerId, stream) {
            // Check if already exists
            if (document.getElementById(`video-${peerId}`)) return;

            const div = document.createElement('div');
            div.id = `video-${peerId}`;
            div.className = "video-container aspect-video bg-slate-800 rounded-lg overflow-hidden border border-slate-700 relative animation-fade-in";
            div.innerHTML = `
                <video autoplay playsinline></video>
                <div class="participant-label">Friend</div>
            `;
            
            const video = div.querySelector('video');
            video.srcObject = stream;

            els.videoGrid.appendChild(div);
            updateParticipantCount();
        }

        function removeRemoteVideo(peerId) {
            const el = document.getElementById(`video-${peerId}`);
            if (el) el.remove();
            delete state.peers[peerId];
            updateParticipantCount();
        }

        function updateParticipantCount() {
            const count = Object.keys(state.peers).length + 1; // +1 for me
            els.partCount.innerText = `${count} Online`;
        }

        function showStatus(msg, isError = false) {
            els.statusMsg.innerText = msg;
            els.statusMsg.className = isError ? "text-sm text-red-400 font-medium" : "text-sm text-green-400 font-medium";
        }

        function generateRoomId() {
            return Math.random().toString(36).substring(2, 7).toUpperCase();
        }

        // --- Event Listeners ---

        els.createBtn.addEventListener('click', async () => {
            els.createBtn.disabled = true;
            els.createBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Creating...`;
            
            const success = await initLocalStream();
            if (!success) {
                els.createBtn.disabled = false;
                els.createBtn.innerHTML = `<i class="fa-solid fa-plus"></i> Create New Room`;
                return;
            }

            const roomId = generateRoomId();
            await initPeer(roomId);

            // UI Transition
            els.setupScreen.classList.add('hidden');
            els.roomInfo.classList.remove('hidden');
            els.displayRoomId.innerText = roomId;
        });

        els.joinBtn.addEventListener('click', async () => {
            const roomId = els.roomInput.value.trim().toUpperCase();
            if (!roomId) {
                showStatus("Please enter a Room ID", true);
                return;
            }

            els.joinBtn.disabled = true;
            els.joinBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;

            const success = await initLocalStream();
            if (!success) {
                els.joinBtn.disabled = false;
                els.joinBtn.innerText = "Join";
                return;
            }

            // Init peer with random ID, then connect to host
            await initPeer(); 

            // Connect to the room (Host ID)
            connectToPeer(roomId);

            // UI Transition
            els.setupScreen.classList.add('hidden');
            els.roomInfo.classList.remove('hidden');
            els.displayRoomId.innerText = roomId;
        });

        els.copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(els.displayRoomId.innerText);
            const originalIcon = els.copyBtn.innerHTML;
            els.copyBtn.innerHTML = `<i class="fa-solid fa-check text-green-500"></i>`;
            setTimeout(() => {
                els.copyBtn.innerHTML = originalIcon;
            }, 2000);
        });

        els.btnMic.addEventListener('click', () => {
            state.isMuted = !state.isMuted;
            state.myStream.getAudioTracks()[0].enabled = !state.isMuted;
            
            els.btnMic.innerHTML = state.isMuted 
                ? `<i class="fa-solid fa-microphone-slash"></i>` 
                : `<i class="fa-solid fa-microphone"></i>`;
            els.btnMic.classList.toggle('bg-red-500', state.isMuted);
            els.btnMic.classList.toggle('hover:bg-red-600', state.isMuted);
            els.btnMic.classList.toggle('bg-slate-800', !state.isMuted);
        });

        els.btnCam.addEventListener('click', () => {
            state.isVideoOff = !state.isVideoOff;
            state.myStream.getVideoTracks()[0].enabled = !state.isVideoOff;
            
            els.btnCam.innerHTML = state.isVideoOff 
                ? `<i class="fa-solid fa-video-slash"></i>` 
                : `<i class="fa-solid fa-video"></i>`;
            els.btnCam.classList.toggle('bg-red-500', state.isVideoOff);
            els.btnCam.classList.toggle('hover:bg-red-600', state.isVideoOff);
            els.btnCam.classList.toggle('bg-slate-800', !state.isVideoOff);
        });

        els.btnShare.addEventListener('click', () => {
            if (state.isSharing) {
                stopScreenShare();
            } else {
                startScreenShare();
            }
        });

        els.btnLeave.addEventListener('click', () => {
            if (confirm("Are you sure you want to leave?")) {
                window.location.reload();
            }
        });

    </script>
</body>
</html>